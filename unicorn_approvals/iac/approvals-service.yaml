# Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
# SPDX-License-Identifier: MIT-0
AWSTemplateFormatVersion: "2010-09-09"
Transform:
  - AWS::Serverless-2016-10-31
Description: >
  Unicorn Approvals Service - A serverless workflow orchestration service for automated 
  property listing validation and approval. Features Step Functions workflows with AI-powered 
  content analysis using Amazon Comprehend and Rekognition, event-driven coordination 
  with external services, and DynamoDB-based state management. Implements the "wait for 
  callback" pattern for human approval processes with comprehensive error handling and 
  observability through AWS Powertools.

Metadata:
  cfn-lint:
    config:
      ignore_checks:
        - ES4000 # Rule disabled because the CatchAll Rule doesn't need a DLQ
        - ES6000 # Rule disabled because SQS DLQs don't need a RedrivePolicy
        - E0001 # Rule disabled because cfn-lint cannot parse SAM Policy templates without arguments (ComprehendBasicAccessPolicy, RekognitionDetectOnlyPolicy)
        - WS2001 # Rule disabled because check does not support !ToJsonString transform
        - ES1001 # Rule disabled because our Lambda functions don't need DestinationConfig.OnFailure
        - W3002 # Rule disabled as nested templates are being packaged

Parameters:
  Stage:
    Type: String
    Default: local
    AllowedValues:
      - local
      - dev
      - prod

Mappings:
  LogsRetentionPeriodMap:
    local:
      Days: 3
    dev:
      Days: 3
    prod:
      Days: 14
  Constants:
    ProjectName:
      Value: "AWS Serverless Developer Experience"

Conditions:
  IsProd: !Equals [!Ref Stage, prod]

Globals:
  Function:
    Runtime: python3.12
    MemorySize: 512
    Timeout: 10
    Tracing: Active
    Architectures:
      - x86_64
    Environment:
      Variables:
        CONTRACT_STATUS_TABLE: !Ref ContractStatusTable
        EVENT_BUS: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ApprovalsEventBus}}"
        SERVICE_NAMESPACE: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
        POWERTOOLS_SERVICE_NAME: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
        POWERTOOLS_TRACE_DISABLED: "false" # Explicitly disables tracing, default
        POWERTOOLS_LOGGER_LOG_EVENT: !If [IsProd, "false", "true"] # Logs incoming event, default
        POWERTOOLS_LOGGER_SAMPLE_RATE: !If [IsProd, "0.1", "0"] # Debug log sampling percentage, default
        POWERTOOLS_METRICS_NAMESPACE: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
        POWERTOOLS_LOG_LEVEL: INFO # Log level for Logger (INFO, DEBUG, etc.), default
        LOG_LEVEL: INFO # Log level for Logger
    Tags:
      stage: !Ref Stage
      project: !FindInMap [Constants, ProjectName, Value]
      namespace: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"

Resources:

  #################################################################################################
  #### LAMBDA FUNCTIONS
  #### These functions handle the core business logic for property approval workflows
  #################################################################################################

  # Event-driven function that processes contract status changes from the Contracts service
  # Triggered by EventBridge when contracts are approved/rejected, updates local state
  ContractStatusChangedHandlerFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../src/
      Handler: approvals_service.contract_status_changed_event_handler.lambda_handler
      Policies:
        - DynamoDBWritePolicy:
            TableName: !Ref ContractStatusTable
        - DynamoDBReadPolicy:
            TableName: !Ref ContractStatusTable
      Events:
        StatusChangedEvent:
          Type: EventBridgeRule
          Properties:
            RuleName: unicorn.approvals-ContractStatusChanged
            EventBusName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ApprovalsEventBus}}"
            Pattern:
              source:
                - "{{resolve:ssm:/uni-prop/UnicornContractsNamespace}}"
              detail-type:
                - ContractStatusChanged
            RetryPolicy:
              MaximumRetryAttempts: 5
              MaximumEventAgeInSeconds: 900
            DeadLetterConfig:
              Arn: !GetAtt ApprovalsEventBusRuleDLQ.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt ApprovalsServiceDLQ.Arn

  # CloudWatch log group for contract status handler with configurable retention based on environment
  ContractStatusChangedHandlerFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/lambda/${ContractStatusChangedHandlerFunction}"
      RetentionInDays: !FindInMap [LogsRetentionPeriodMap, !Ref Stage, Days]

  # DynamoDB stream processor that resumes paused Step Functions executions
  # Monitors ContractStatusTable changes and sends task success signals to waiting workflows
  PropertiesApprovalSyncFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../src/
      Handler: approvals_service.properties_approval_sync_function.lambda_handler
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref ContractStatusTable
        - DynamoDBStreamReadPolicy:
            TableName: !Ref ContractStatusTable
            StreamName:
              !Select [3, !Split ["/", !GetAtt ContractStatusTable.StreamArn]]
        - SQSSendMessagePolicy:
            QueueName: !GetAtt ApprovalsServiceDLQ.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - states:SendTaskSuccess
              Resource:
                - !Ref ApprovalStateMachine
      Events:
        Stream:
          Type: DynamoDB
          Properties:
            Stream: !GetAtt ContractStatusTable.StreamArn
            BatchSize: 100
            StartingPosition: TRIM_HORIZON
            MaximumRetryAttempts: 3
            DestinationConfig:
              OnFailure:
                Destination: !GetAtt ApprovalsServiceDLQ.Arn
      EventInvokeConfig:
        DestinationConfig:
          OnFailure:
            Type: SQS
            Destination: !GetAtt ApprovalsServiceDLQ.Arn

  # CloudWatch log group for the sync function that handles Step Functions resume operations
  PropertiesApprovalSyncFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/lambda/${PropertiesApprovalSyncFunction}"
      RetentionInDays: !FindInMap [LogsRetentionPeriodMap, !Ref Stage, Days]

  # Step Functions task that implements the "wait for approval" pattern
  # Stores execution tokens in DynamoDB and pauses workflow until external approval is received
  WaitForContractApprovalFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: ../src/
      Handler: approvals_service.wait_for_contract_approval_function.lambda_handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ContractStatusTable

  # CloudWatch log group for the contract approval wait function
  WaitForContractApprovalFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/lambda/${WaitForContractApprovalFunction}"
      RetentionInDays: !FindInMap [LogsRetentionPeriodMap, !Ref Stage, Days]

  #################################################################################################
  #### STATE MACHINE
  #### Orchestrates the property approval workflow using AWS Step Functions
  #################################################################################################

  # Main workflow that orchestrates property approval process including content validation,
  # image analysis using Rekognition, text analysis using Comprehend, and contract approval
  ApprovalStateMachine:
    Type: AWS::Serverless::StateMachine
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Name: !Sub "${AWS::StackName}-ApprovalStateMachine"
      DefinitionUri: ./state-machine/property_approval.asl.yaml
      Tracing:
        Enabled: true
      Policies:
        - AWSXRayDaemonWriteAccess
        - ComprehendBasicAccessPolicy: {}
        - RekognitionDetectOnlyPolicy: {}
        - LambdaInvokePolicy:
            FunctionName: !Ref WaitForContractApprovalFunction
        - DynamoDBReadPolicy:
            TableName: !Ref ContractStatusTable
        - S3ReadPolicy:
            BucketName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ImagesBucket}}"
        - EventBridgePutEventsPolicy:
            EventBusName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ApprovalsEventBus}}"
        - Statement:
            - Effect: Allow
              Action:
                - logs:CreateLogDelivery
                - logs:GetLogDelivery
                - logs:UpdateLogDelivery
                - logs:DeleteLogDelivery
                - logs:ListLogDeliveries
                - logs:PutResourcePolicy
                - logs:DescribeResourcePolicies
                - logs:DescribeLogGroups
                - cloudwatch:PutMetricData
              Resource: "*"
      Logging:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn: !GetAtt ApprovalStateMachineLogGroup.Arn
        Level: ALL
        IncludeExecutionData: true
      Events:
        PublicationApprovalRequestedEvent:
          Type: EventBridgeRule
          Properties:
            RuleName: unicorn.approvals-PublicationApprovalRequested
            EventBusName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ApprovalsEventBus}}"
            Pattern:
              source:
                - "{{resolve:ssm:/uni-prop/UnicornWebNamespace}}"
              detail-type:
                - PublicationApprovalRequested
            RetryPolicy:
              MaximumRetryAttempts: 5
              MaximumEventAgeInSeconds: 900
            DeadLetterConfig:
              Type: SQS
              Destination: !GetAtt ApprovalsServiceDLQ.Arn
      DefinitionSubstitutions:
        WaitForContractApprovalArn: !GetAtt WaitForContractApprovalFunction.Arn
        TableName: !Ref ContractStatusTable
        ImageUploadBucketName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ImagesBucket}}"
        EventBusName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ApprovalsEventBus}}"
        ServiceName: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"

  # CloudWatch log group for Step Functions execution logs with detailed tracing enabled
  ApprovalStateMachineLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub "/aws/states/${AWS::StackName}-ApprovalStateMachine"
      RetentionInDays: !FindInMap [LogsRetentionPeriodMap, !Ref Stage, Days]

  #################################################################################################
  #### MESSAGING & INTEGRATION
  #### SQS queues and EventBridge components for reliable async processing and event publishing
  #################################################################################################

  # DLQ for EventBridge rule delivery failures - captures events that couldn't be delivered to targets
  # Helps with debugging event routing issues and ensures no events are lost
  ApprovalsEventBusRuleDLQ:
    Type: AWS::SQS::Queue
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      SqsManagedSseEnabled: true
      MessageRetentionPeriod: 604800 # 7 days
      Tags:
        - Key: project
          Value: !FindInMap [Constants, ProjectName, Value]
        - Key: namespace
          Value: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
        - Key: stage
          Value: !Ref Stage

  # DLQ for Lambda function invocation failures - captures failed executions for analysis
  # Used by all Lambda functions in this service for consistent error handling
  ApprovalsServiceDLQ:
    Type: AWS::SQS::Queue
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      SqsManagedSseEnabled: true
      MessageRetentionPeriod: 604800 # 7 days
      Tags:
        - Key: project
          Value: !FindInMap [Constants, ProjectName, Value]
        - Key: namespace
          Value: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
        - Key: stage
          Value: !Ref Stage

  #################################################################################################
  #### DYNAMODB TABLE
  #### Data persistence for contract approval state and Step Functions coordination
  #################################################################################################

  # Central state store for contract approval status and Step Functions task tokens
  # Enables coordination between async approval processes and workflow execution
  ContractStatusTable:
    Type: AWS::DynamoDB::Table
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      AttributeDefinitions:
        - AttributeName: property_id
          AttributeType: S
      KeySchema:
        - AttributeName: property_id
          KeyType: HASH
      StreamSpecification:
        StreamViewType: NEW_AND_OLD_IMAGES
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: project
          Value: !FindInMap [Constants, ProjectName, Value]
        - Key: namespace
          Value: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
        - Key: stage
          Value: !Ref Stage

  # Development and debugging rule that captures all events from related services
  # Useful for monitoring event flow and troubleshooting integration issues
  UnicornApprovalsCatchAllRule:
    Type: AWS::Events::Rule
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Name: approvals.catchall
      Description: Catchall rule used for development purposes.
      EventBusName: !Sub "{{resolve:ssm:/uni-prop/${Stage}/ApprovalsEventBus}}"
      EventPattern:
        account:
          - !Ref AWS::AccountId
        source:
          - "{{resolve:ssm:/uni-prop/UnicornContractsNamespace}}"
          - "{{resolve:ssm:/uni-prop/UnicornWebNamespace}}"
      State: ENABLED #You may want to disable this rule in production
      Targets:
        - Arn: !GetAtt UnicornApprovalsCatchAllLogGroup.Arn
          Id: !Sub UnicornApprovalsCatchAllLogGroupTarget-${Stage}

  # CloudWatch log group for the catchall rule - stores all events for debugging
  UnicornApprovalsCatchAllLogGroup:
    Type: AWS::Logs::LogGroup
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      LogGroupName: !Sub
        - "/aws/events/${Stage}/${NS}-catchall"
        - Stage: !Ref Stage
          NS: "{{resolve:ssm:/uni-prop/UnicornApprovalsNamespace}}"
      RetentionInDays: !FindInMap [LogsRetentionPeriodMap, !Ref Stage, Days]

  # Resource policy that grants EventBridge permission to write to CloudWatch Logs
  # Required for the catchall rule to function properly
  EventBridgeCloudWatchLogGroupPolicy:
    Type: AWS::Logs::ResourcePolicy
    Properties:
      PolicyName: !Sub EvBToCWLogs-${AWS::StackName}
      # Note: PolicyDocument has to be established this way. See https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-resource-logs-resourcepolicy.html#cfn-logs-resourcepolicy-policydocument
      PolicyDocument: !Sub |
        {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": [
                  "delivery.logs.amazonaws.com",
                  "events.amazonaws.com"
                ]
              },
              "Action": [
                "logs:CreateLogStream",
                "logs:PutLogEvents"
              ],
              "Resource": [
                "${UnicornApprovalsCatchAllLogGroup.Arn}"
              ]
            }
          ]
        }

Outputs:
  #### DYNAMODB OUTPUTS
  ContractStatusTableName:
    Description: DynamoDB table storing contract status information
    Value: !Ref ContractStatusTable

  #### LAMBDA FUNCTIONS OUTPUTS
  ContractStatusChangedHandlerFunctionName:
    Value: !Ref ContractStatusChangedHandlerFunction
  ContractStatusChangedHandlerFunctionArn:
    Value: !GetAtt ContractStatusChangedHandlerFunction.Arn

  PropertiesApprovalSyncFunctionName:
    Value: !Ref PropertiesApprovalSyncFunction
  PropertiesApprovalSyncFunctionArn:
    Value: !GetAtt PropertiesApprovalSyncFunction.Arn

  WaitForContractApprovalFunctionName:
    Value: !Ref WaitForContractApprovalFunction
  WaitForContractApprovalFunctionArn:
    Value: !GetAtt WaitForContractApprovalFunction.Arn

  #### STEPFUNCTIONS OUTPUTS
  ApprovalStateMachineName:
    Value: !GetAtt ApprovalStateMachine.Name
  ApprovalStateMachineArn:
    Value: !Ref ApprovalStateMachine

  #### CLOUDWATCH LOGS OUTPUTS
  UnicornApprovalsCatchAllLogGroupArn:
    Description: Log all events on the service's EventBridge Bus
    Value: !GetAtt UnicornApprovalsCatchAllLogGroup.Arn

  ApprovalStateMachineLogGroupName:
    Value: !Ref ApprovalStateMachineLogGroup
